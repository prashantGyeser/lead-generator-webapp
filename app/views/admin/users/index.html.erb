<!-- BEGIN PAGE TITLE -->
<div class="page-title">
  <h3 class="semi-bold">
    Users
  </h3>

</div>
<!-- END PAGE TITLE -->

<div class="row">
  <div class="col-md-12">
    <div class="grid simple">
      <div class="grid-body">
        <h3></h3>

        <div class="invite_user_form">

          <%= form_for User.new, :url => user_invitation_path, :html => {:method => :post} do |f| %>
            <%# devise_error_messages! %>

            <%= f.text_field :email, placeholder: "Email of user to invite" %>
            <%= f.submit "Invite User", class: "btn btn_primary", style: "width: inherit;" %>
          <% end %>

        </div>





        <table class="table table-condensed m-t-30" id="example">
          <thead>
          <tr>
            <th style="width:11%">Lead Stream</th>
            <th style="width:10%" data-hide="phone,tablet">Tweets Remaining</th>
            <th style="width:10%">Todays Leads</th>
            <th style="width:6%" data-hide="phone,tablet">Months Leads</th>
            <th style="width:12%" data-hide="phone,tablet">Replies</th>
          </tr>
          </thead>
          <tbody>

          <% @users.each do |user| %>

            <tr>
              <td colspan="4" class="bold">
                <%= user.email %>
                <%= user.active? ? ("<span class='label label-success'>Active</span>".html_safe):("<span class='label'>Inactive</span>".html_safe) %>
              </td>
              <td><%= TweetReply.where(user_id: current_user.id).count %></td>
            </tr>

            <% LeadStream.where(user_id: user.id).each do |lead_stream| %>
              <% keywords = Keyword.where(lead_stream_id: lead_stream.id) %>

              <% keyword_ids = [] %>
              <% keywords.each do |keyword| %>
              <% keyword_ids << keyword.id %>
              <% end %>

              <% unprocessed_tweet_count = UnprocessedTweet.where(keyword_id: keyword_ids).where(processed: nil).count %>
              <% leads_today = Lead.where(keyword_id: keyword_ids).where("created_at >= ?", Time.zone.now.beginning_of_day).count %>
              <% leads_this_month = Lead.where(keyword_id: keyword_ids).past_month.count %>

              <tr>
                <td style="border-top: none;">
                  <span class=""><%= lead_stream.name.nil? ? (lead_stream.city_name):(lead_stream.name) %></span>

                  <table>
                    <% keywords.each do |keyword| %>
                      <tr>
                        <td style="border: none" class="bold">
                          <a href="/admin/leads/qc/<%= keyword.id %>"><%= keyword.term %></a>
                          <% tweets_to_qc = UnprocessedTweet.where(keyword_id: keyword.id).where(processed: nil).count %>
                          <span class="badge <%= tweets_to_qc < 5 ? "badge-important":"badge-success" %>"><%= tweets_to_qc %></span>
                        </td>
                      </tr>
                    <% end %>

                  </table>
                </td>
                <td style="border-top: none;"><%= unprocessed_tweet_count %></td>
                <td style="border-top: none;"><%= leads_today %></td>
                <td style="border-top: none;"><%= leads_this_month %></td>

              </tr>
            <% end %>


          <% end %>





          </tbody>
        </table>



      </div>
    </div>

  </div>
</div>





